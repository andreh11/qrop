version: 0.1_b{build}
configuration: Release

branches:
  only:
    - master

environment:
  DEPLOY_DIR: Qrop-%APPVEYOR_BUILD_VERSION%
  matrix:
    - name: mingw53_32
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      platform: amd64_x86
      qt: 5.11\mingw53_32
      suffix: mingw53_32
      arch: x86

    # MSVC x86
    - name: win32
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      platform: amd64_x86
      qt: 5.11\msvc2015
      suffix: msvc2015
      arch: x86

    # MSVC x64
    - name: amd64
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      platform: amd64
      qt: 5.11\msvc2015_64
      suffix: msvc2015
      arch: x64

init:
  - set PATH=C:\Qt\%qt%\bin;%PATH%
  - if %name%==win32 call "%ProgramFiles(x86)%\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" %arch%
  - if %name%==amd64 call "C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.cmd" /x64
  - if %name%==amd64 call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" x86_amd64
  - if %name%==mingw53_32 set PATH=C:\MinGW\bin;%PATH%
  - cd /D "%APPVEYOR_BUILD_FOLDER%"

build_script:
  - cd C:\projects\qrop
  - qmake -config release qrop.pro CONFIG+=windows PREFIX="%DEPLOY_DIR%"
  - if %name%==mingw53_32 (mingw32-make) else (nmake)

after_build:
  - if %name%==mingw53_32 (mingw32-make install) else (nmake install)
  - cmd: cp core/release/*.dll "desktop/%DEPLOY_DIR%"
  - if %name%==mingw53_32 xcopy "C:\Qt\%qt%\bin\libwinpthread-1.dll" "desktop\%DEPLOY_DIR%"
  - xcopy "C:\Qt\%qt%\bin\libstdc++-*.dll" "desktop\%DEPLOY_DIR%"
  - windeployqt --release --qmldir desktop/qml "desktop\%DEPLOY_DIR%\desktop.exe"
  - 7z a qrop-%APPVEYOR_BUILD_VERSION%-%name%.zip "desktop\%DEPLOY_DIR%"

artifacts:
  - path: qrop-%APPVEYOR_BUILD_VERSION%-%name%.zip
    name: release
