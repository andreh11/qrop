language: cpp
compiler: g++
os: linux
dist: xenial

matrix:
  include:
    - os: linux
      dist: xenial
      sudo: required
    - os: osx
      osx_image: xcode7.2

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo add-apt-repository ppa:beineri/opt-qt-5.12.0-xenial -y; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo apt-get update     ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update               ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install qt           ; fi

install:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo apt-get install -y qt512-meta-full qt512charts-no-lgpl; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo apt-get install -y build-essential libfontconfig1 mesa-common-dev libglu1-mesa-dev; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then source /opt/qt512/bin/qt512-env.sh; fi

script:
  - mkdir build;
  - cd build;
  - qmake -config release ..;
  - make -j 8;
  - mkdir -p deploy/usr/bin deploy/usr/lib deploy/usr/share;
  - mkdir deploy/usr/share/applications;
  - find . \( -name "moc_*" -or -name "*.o" -or -name "qrc_*" -or -name "Makefile*" -or -name "*.a" \) -exec rm {} \;
  - cp -R core/* desktop/* deploy/usr/bin
  - cd deploy;
  - cp ../../logo.png desktop.png
  - cp ../../dist/Qrop.desktop usr/share/applications
  - wget -c "https://github.com/probonopd/linuxdeployqt/releases/download/5/linuxdeployqt-5-x86_64.AppImage"
  - chmod a+x linuxdeployqt*.AppImage;
  - unset QTDIR; unset QT_PLUGIN_PATH ; unset LD_LIBRARY_PATH;
  - ./linuxdeployqt*.AppImage usr/share/applications/Qrop.desktop -verbose=2 -qmldir=$TRAVIS_BUILD_DIR/desktop/qml -bundle-non-qt-libs -extra-plugins=sqldrivers,imageformats/libqsvg.so"
  - ./linuxdeployqt*.AppImage usr/share/applications/Qrop.desktop -verbose=2 -qmldir=$TRAVIS_BUILD_DIR/desktop/qml -appimage
  - find . | grep AppImage;

deploy:
  provider: releases
  api_key: $GH_TOKEN
  file: build/deploy/Qrop-x86_64.AppImage
  skip_cleanup: true
  draft: true

env:
  global:
    secure: a2sSFPhaFFjFPaJz9kWr1WCJGP1H4301Dhd8TzGR4ZxfqGpFjMn1k+92eVO3QKc9zVmSgHx95hIsSARMOs1yDaKthASSkkLBsrY9Uep6zGX9AXA8+N+pSMLtDnmgNlVfcPYGhewObGtP8wIToQ1RM3K7JUzOPtkQDEWUlxcJ71bJFwewR8MKPLF1/hWKOLpyUX1yydldAupR/cas3kJIanA60OTyAgJbeuD8wVWTKSw9f6iIu3ui3s1tfwV6gRoEeJdFPKy1ltTxbeUwB5M9bLhBoJqQ/zncy7dy1FA6eFM0hb15Py2lIzchJ3/vFK/RUuYMnmBTgQZXBBnwf+fQ405kmZYOcuU/wE1nBuOt73g7RSdUe4qocs64tJyKBaW25DOMpLvdDTMxfJXt+jtXT0RyBcYoM5K4EP2tN98Kjq1Z3r9JGLbAwZzagdTX+IUx8eyiwJGssnAuOA7S/iyE+i1noMkVnPfuOthn9ZLf6cw1fyOA0PCt+fWtqWu9BF7yCJGVCg7dka0rQwrrw/oK782djJHOtiR3Jf3N7k9+Hyw3BWs7YMtXmNFWzUpLS1BrjMCIKoEPSskQFgom0eJ4TkLrfHi8DBrFUiGhhtrTe5BVqtvYSUT9GwkbAsEs9hjL3kJ400+3X/ceQUJiN9hAv9Zntql9+RkP9RbqopLQGW4=
